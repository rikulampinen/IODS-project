# Chapter 6: Dimensionality reduction techniques

### Data wrangling and performing an analysis of longitudinal data

#### *Work of week 49 (02.12. - 08.12.2019)*

***

The data wrangling of two data sets (bprs & rats) was performed before. The script of the data wrangling exercise can be found [here](https://github.com/rikulampinen/IODS-project/blob/master/data/meet_and_repeat.R).  


## 1. Load and check the data sets


## 1.1. Load the wide (bprs & rats) and long (bprs_l & rats_l) data sets

```{r, packages, echo=TRUE, results='markdown', message=FALSE, warning=FALSE}
# load necessary packages
library(tidyr)
library(dplyr)
library(corrplot)
library(ggplot2)
library(GGally)
library(knitr)
library(kableExtra)
library(stringr)
library(lme4)
```

```{r, loaddata, echo=TRUE, results='markdown', message=FALSE, warning=FALSE}
# load the wide data sets
bprs <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/BPRS.txt", sep = " ", header = TRUE)

rats <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt", header = TRUE)

# load the long data sets
bprs_l <- read.table("C:/Users/richla/OneDrive/1 C - R-Folder/11-IODS-course/IODS-project/data/bprs_l.txt")
rats_l <- read.table("C:/Users/richla/OneDrive/1 C - R-Folder/11-IODS-course/IODS-project/data/rats_l.txt")

# check the data sets
str(bprs_l) 
str(rats_l)

# bprs data --> factor treatment & subject
bprs_l$treatment <- factor(bprs_l$treatment)
bprs_l$subject <- factor(bprs_l$subject)

# rats data --> factor ID & Group
rats_l$ID <- factor(rats_l$ID)
rats_l$Group <- factor(rats_l$Group)

# check the data again
glimpse(bprs_l)
glimpse(rats_l)
```
  
The categorical variables were not set as factors anymore, so I factorized them again. See the upper code.
  
The BPRS data set:  
The BPRS (brief psychiatric rating scale) was measured on 40 male subjects with 2 treatment groups. One BPRS measurement was done before treatment started (week0), then weekly measurements followed up to 8 weeks in total.

Rats data set:
--> 
  
***  
  
## 1.2.The long data sets (bprs_l & rats_l)

```{r, checkdata, echo=TRUE, results='markdown', message=FALSE, warning=FALSE}
# bprs_l data set
knitr::kable(bprs_l, caption = "BPRS - long data set") %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "center") %>% 
  scroll_box(height = "300px")

# rats_ data set
knitr::kable(rats_l, caption = "RATS - long data set") %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "center") %>% 
  scroll_box(height = "300px")
```
  
***
  
## 2. Analysis of the long data sets (bprs_l & rats_l)

The data set analyses are swapped. So we run the data analyses of MABS book chapter 8 on the "rats_l" data set and the analyses of MABS book chapter 9 on the "bprs_l" data set.

## 3. Analyses of Chapter 8 of MABS using the RATS data (rats_l)

### 3.1. A first plot

```{r, rats_lanalysis1, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
# rats_l data set

# plot 1
ggplot(rats_l, aes(x = Time, y = Weight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:16, times = 11)) + # needs to be checked!!!
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(rats_l$Weight), max(rats_l$Weight))) + 
  ggtitle("RATS - long data")
```

? What to do with + scale_linetype_manual(values = rep(1:10, times=4))

***

### 3.2. Standardized data

```{r, rats_lanalysis2, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
head(rats_l)

# Standardise the variable Weight
rats_l <- rats_l %>%
  group_by(Time) %>%
  mutate(StdWeight = ((Weight - mean(Weight))/sd(Weight))) %>%
  ungroup()

# Glimpse the data
glimpse(rats_l)

# Plot again with the standardised bprs
ggplot(rats_l, aes(x = Time, y = StdWeight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:16, times=11)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_y_continuous(name = "Standardized Weight") +
  ggtitle("Standardized Weight")

```

***
  
### 3.3. Summary graphs

```{r, rats_lanalysis3, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
str(rats_l)

# Number of Time, baseline (Time = 1) included
n_rats <- rats_l$Time %>% unique() %>% length()
n_rats
# Summary data with mean and standard error of rats_l by group and time 
rats_s <- rats_l %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = (sd(Weight)/sqrt(n_rats))) %>%
  ungroup()

# Glimpse the data
str(rats_s)

# Plot the mean profiles
ggplot(rats_s, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line(col = "darkgreen") +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=2) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.8) +
  theme(legend.position = "right") +
  scale_y_continuous(name = "mean(Weight) +/- se(Weight)")
```

***

### 3.4. Find the outlier

```{r, rats_lanalysis4, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
str(rats_l)

# Create a summary data by Group and ID with mean as the summary variable (ignoring baseline Time 1).
rats_l10s <- rats_l %>%
  filter(Time > 1) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()

# Glimpse the data
glimpse(rats_l10s)

# Draw a boxplot of the mean versus group
ggplot(rats_l10s, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "darkgreen") +
  scale_y_continuous(name = "mean(Weight), Time 8-64")

# Create a new data by filtering the outliers and adjust the ggplot code the draw the plot again with the new data
rats_l10s1 <- rats_l10s %>%
    filter(mean < 550) %>%
      ungroup()
str(rats_l10s1)

# Draw a boxplot of the mean versus group with the outlier filtered data
ggplot(rats_l10s1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "darkgreen") +
  scale_y_continuous(name = "mean(Weight), Time 8-64")
```


***

### 3.5. T-test and ANOVA


```{r, rats_lanalysis5, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
str(rats_l10s1)

# Two-sample t-test
t.test(mean ~ Group == c(1,3), data = rats_l10s1) # that needs to be checked !!!!!!!!!!!!!!!!!!!

# Add the baseline from the original data as a new variable to the summary data
rats_l10s2 <- rats_l10s %>%
  mutate(baseline = rats$WD1)

rats_l10s2

# Fit the linear model with the mean as the response 
rats_fit <- lm(mean ~ baseline + Group, data = rats_l10s2)

# Compute the analysis of variance table for the fitted model with anova()
anova(rats_fit)
```
Check the results on the two sample t.test --> this needs to be checked
I could compare via t.test group 1 & 2 / 1 & 3 / 2 & 3

***


## 4. Analyses of Chapter 9 of MABS using the BPRS data (bprs_l)

### 4.1. A first plot

```{r, bprs_lanalysis1, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}

str(bprs_l)

#plotting the bprs_l data
ggplot(bprs_l, aes(x = week, y = bprs, group = treatment)) +
  geom_point() + 
  scale_x_continuous(name = "Weeks", breaks = seq(0,8)) + 
  scale_y_continuous(name = "BPRS value") + 
  theme(legend.position = "top") + 
  ggtitle("BPRS value overview")

#plotting the bprs_l data
ggplot(bprs_l, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  facet_grid(. ~ treatment, labeller = label_both) +
  scale_x_continuous(name = "Weeks", breaks = seq(0,8,1)) + 
  scale_y_continuous(name = "BPRS values observed", breaks = seq(10,100,5)) + 
  theme(legend.position = "bottom") + 
  ggtitle("BPRS value overview")



```
  
***

### 4.2. Linear model of bprs data

```{r, bprs_lanalysis2, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}

# create a regression model bprs_l_reg
bprs_l_reg <- lm(bprs ~ week + treatment, data = bprs_l)

# print out a summary of the model
summary(bprs_l_reg)
```
  
  
*** 

### 4.3. Random Intercept Model

```{r, bprs_lanalysis3, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
# Create a random intercept model
bprs_l_rim <- lmer(bprs ~ week + treatment + (1 | subject), data = bprs_l, REML = FALSE)

# Print the summary of the model
summary(bprs_l_rim)
```
  

*** 

### 4.4. Random Intercept and Random Slope Model

```{r, bprs_lanalysis4, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}

# create a random intercept and random slope model
bprs_l_rim1 <- lmer(bprs ~ week + treatment + (week | subject), data = bprs_l, REML = FALSE)

# print a summary of the model
summary(bprs_l_rim1)

# perform an ANOVA test on the two models
anova(bprs_l_rim1, bprs_l_rim)
```
  
***

### 4.5. Random Intercept and Random Slope Model with interaction

```{r, bprs_lanalysis5, echo=TRUE, results='markdown', message=FALSE, warning=FALSE, fig.align = 'center'}
# create a random intercept and random slope model
bprs_l_rim2 <- lmer(bprs ~ week * treatment + (week | subject), data = bprs_l, REML = FALSE)

# print a summary of the model
summary(bprs_l_rim2)

# perform an ANOVA test on the two models
anova(bprs_l_rim2, bprs_l_rim1)

# draw the plot of bprs_l
ggplot(bprs_l, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  facet_grid(. ~ treatment, labeller = label_both) +
  scale_x_continuous(name = "Weeks", breaks = seq(0,8,1)) + 
  scale_y_continuous(name = "BPRS values observed", breaks = seq(10,100,5)) + 
  theme(legend.position = "bottom") + 
  ggtitle("BPRS value overview")

# Create a vector of the fitted values
bprs_l_fit <- fitted(bprs_l_rim2)

# Create a new column "fitted_bprs" to bprs_l
bprs_l$fitted_bprs <- bprs_l_fit

# draw the plot of fitted bprs values
ggplot(bprs_l, aes(x = week, y = fitted_bprs, linetype = subject)) +
  geom_line() +
  facet_grid(. ~ treatment, labeller = label_both) +
  scale_x_continuous(name = "Weeks", breaks = seq(0,8,1)) + 
  scale_y_continuous(name = "BPRS values modeled", breaks = seq(10,100,5)) + 
  theme(legend.position = "bottom") + 
  ggtitle("BPRS value overview")
```



